<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8" /><meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover"
  /><title>Patient's Trip</title
  ><link rel="stylesheet" href="assets/css/style.css" />
  <script src="assets/js/app.js"></script>
  <header class="header">
    <a
      class="logo"
      data-hospital-link
      href="https://example.org"
      target="_blank"
      rel="noopener"
    >
      <img
        alt="Hospital"
        data-hospital-logo
        src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='72' height='72'><rect width='100%' height='100%' rx='12' ry='12' fill='%23ffffff'/><circle cx='36' cy='36' r='22' fill='%232dd4bf'/><path d='M36 18v36M18 36h36' stroke='%230b1220' stroke-width='6' stroke-linecap='round'/></svg>"
      />
      <div class="title"><span data-hospital-name>Your Hospital</span></div>
    </a>
    <a class="jump" href="menu.html">Home</a>
  </header>
  <body>
    <div class="container">
      <div class="card">
        <div class="badge">Select your purpose of visit</div>
        <select id="purpose">
          <option value="">-- Choose --</option>
          <option value="health">Health Check</option>
          <option value="blood">Blood Test</option>
          <option value="xray">X-Ray</option>
          <option value="clinic">Clinic Visit</option>
          <option value="doctor">Doctor's Appointment</option>
        </select>
        <hr class="sep" />
        <div id="steps" class="grid"></div>
      </div>
    </div>
  </body>
  <script>
    App.applyHeader();

    var journeys = {
      health: [
        "Registration",
        "Triage",
        "ECG",
        "X-Ray",
        "Consultation",
        "Pharmacy",
      ],
      blood: [
        "Registration",
        "Triage",
        "Blood Draw",
        "Consultation",
        "Pharmacy",
      ],
      xray: ["Registration", "Triage", "X-ray", "Consultation", "Pharmacy"],
      clinic: ["Registration", "Clinic Counter", "Consultation", "Pharmacy"],
      doctor: ["Registration", "Consultation", "Pharmacy"],
    };
    var mapTargets = {
      Registration: "counter_reg",
      Triage: "triage",
      ECG: "ecg_room",
      "X-ray": "xray_lab",
      "Blood Draw": "phlebotomy",
      "Clinic Counter": "clinic_counter",
      Consultation: "consult_room",
      Pharmacy: "pharmacy",
    };
    var steps = document.getElementById("steps");
    var prevStep = "";
    var purpose = document.getElementById("purpose");

    window.addEventListener("load", render);
    purpose.addEventListener("change", resetJourney);
    purpose.addEventListener("change", render);
    function render() {
      console.log("loaded");
      steps.innerHTML = "";
      var key = purpose.value;
      if (!key) return;
      // Set steps of selected purpose in localStorage
      localStorage.setItem(
        "patient_journey_steps",
        JSON.stringify(journeys[key])
      );
      localStorage.setItem("patient_journey_current_step", "0");

      journeys[key].forEach(function (step) {
        var row = document.createElement("div");
        row.className = "grid";
        row.innerHTML =
          '<label><input type="checkbox" style="transform:scale(1.2)"/> ' +
          step +
          "</label>" +
          '<div class="grid cols-2">' +
          '<button class="btn" data-step="' +
          step +
          '"' +
          `data-prev-step='${prevStep}'` +
          ">Show me the way</button>" +
          '<button class="btn ghost">Info</button>' +
          '</div><hr class="sep">';
        steps.appendChild(row);
        prevStep = step;
        console.log(step);
      });
      [].slice
        .call(steps.querySelectorAll("[data-step]"))
        .forEach(function (btn) {
          btn.addEventListener("click", function () {
            var step = btn.getAttribute("data-step");
            var prevStepAttr = btn.getAttribute("data-prev-step");
            var dest = mapTargets[step] || "poi";
            App.go(
              "map.html?dest=" +
                encodeURIComponent(dest) +
                "&label=" +
                encodeURIComponent(step) +
                "&from=" +
                encodeURIComponent(prevStepAttr)
            );
          });
        });
      var checkboxes = steps.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach(function (checkbox) {
        checkbox.addEventListener("change", trackJourney);
      });
    }
    function trackJourney() {
      // Read the state of the checkboxes and update localStorage
      var checkboxes = steps.querySelectorAll("input[type='checkbox']");
      var mostUpdatedStepIndex = -1;
      checkboxes.forEach(function (checkbox, index) {
        if (checkbox.checked) {
          mostUpdatedStepIndex = index;
        }
      });
      console.log("Most updated step index:", mostUpdatedStepIndex);
      localStorage.setItem(
        "patient_journey_current_step",
        mostUpdatedStepIndex.toString()
      );

      // Set the colour of the background of each step to green if completed
      /*
      checkboxes.forEach(function (checkbox, index) {
        stepCard = checkbox.parentElement.parentElement;
        if (index <= mostUpdatedStepIndex) {
          stepCard.style.backgroundColor = "#2dd4bf"; // bright green
        } else {
          stepCard.style.backgroundColor = ""; // default
        }
      });
      */
    }

    function resetJourney() {
      // Check if option saved in localStorage matches current selection
      if (App.getPatientPurpose() !== purpose.value) {
        // Show a popup to confirm reset
        var confirmReset = confirm(
          "Changing your purpose will reset your current journey. Do you want to proceed?"
        );

        if (confirmReset) {
          // User confirmed, reset the saved journey
          App.setPatientPurpose(purpose.value);
        } else {
          // User canceled, revert the selection to the saved purpose
          var savedPurpose = App.getPatientPurpose();
          purpose.value = savedPurpose || "";
          render(); // Re-render the steps based on the reverted selection
        }
      }
    }
  </script>
</html>
